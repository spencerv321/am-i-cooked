<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Am I Cooked? ‚Äî Dashboard</title>
<link rel="icon" type="image/svg+xml" href="/favicon.svg">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=JetBrains+Mono:wght@400;500;700&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: #0a0a0a;
    color: #e5e5e5;
    font-family: 'Inter', system-ui, sans-serif;
    min-height: 100vh;
    padding: 24px;
  }

  .mono { font-family: 'JetBrains Mono', monospace; }

  /* Login */
  #login {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 80vh;
    gap: 16px;
  }
  #login h1 { font-size: 24px; font-weight: 900; text-transform: uppercase; }
  #login input {
    background: #141414;
    border: 1px solid #2a2a2a;
    border-radius: 8px;
    padding: 12px 16px;
    color: white;
    font-family: 'JetBrains Mono', monospace;
    font-size: 14px;
    width: 300px;
    outline: none;
  }
  #login input:focus { border-color: #555; }
  #login button {
    background: white;
    color: black;
    border: none;
    border-radius: 8px;
    padding: 10px 24px;
    font-weight: 700;
    cursor: pointer;
    font-size: 14px;
  }
  #login button:hover { background: #ddd; }
  #login .error { color: #ef4444; font-size: 13px; }

  /* Dashboard */
  #dashboard { display: none; max-width: 1200px; margin: 0 auto; }

  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 32px;
    flex-wrap: wrap;
    gap: 8px;
  }
  header h1 { font-size: 20px; font-weight: 900; text-transform: uppercase; }
  header .meta { color: #666; font-size: 12px; font-family: 'JetBrains Mono', monospace; }

  /* Hero */
  .hero {
    text-align: center;
    padding: 32px;
    margin-bottom: 24px;
  }
  .hero .big-number {
    font-size: 72px;
    font-weight: 900;
    font-family: 'JetBrains Mono', monospace;
    color: white;
    line-height: 1;
  }
  .hero .label {
    font-size: 14px;
    color: #666;
    font-family: 'JetBrains Mono', monospace;
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-top: 8px;
  }
  .hero .pulse {
    display: inline-block;
    width: 8px;
    height: 8px;
    background: #22c55e;
    border-radius: 50%;
    margin-right: 8px;
    animation: pulse 2s infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  /* Stat cards */
  .stat-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 24px;
  }
  .stat-grid-4 {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 24px;
  }
  .stat-card {
    background: #141414;
    border: 1px solid #2a2a2a;
    border-radius: 8px;
    padding: 16px;
  }
  .stat-card .value {
    font-size: 28px;
    font-weight: 700;
    font-family: 'JetBrains Mono', monospace;
    color: white;
  }
  .stat-card .label {
    font-size: 11px;
    color: #666;
    font-family: 'JetBrains Mono', monospace;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 4px;
  }
  .delta {
    font-size: 12px;
    font-family: 'JetBrains Mono', monospace;
    margin-left: 6px;
  }
  .delta.up { color: #22c55e; }
  .delta.down { color: #ef4444; }
  .delta.flat { color: #666; }

  /* Section */
  .section {
    background: #141414;
    border: 1px solid #2a2a2a;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 16px;
  }
  .section h2 {
    font-size: 11px;
    font-family: 'JetBrains Mono', monospace;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: #666;
    margin-bottom: 16px;
  }

  /* Two column layout */
  .two-col {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 16px;
  }

  /* Ranked list */
  .ranked-list { list-style: none; }
  .ranked-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 6px 0;
    border-bottom: 1px solid #1a1a1a;
    font-size: 13px;
  }
  .ranked-item:last-child { border-bottom: none; }
  .ranked-item .rank {
    font-family: 'JetBrains Mono', monospace;
    color: #555;
    width: 24px;
    text-align: right;
    flex-shrink: 0;
  }
  .ranked-item .title {
    flex: 1;
    text-transform: capitalize;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .ranked-item .bar-wrap {
    width: 80px;
    height: 6px;
    background: #1a1a1a;
    border-radius: 3px;
    flex-shrink: 0;
  }
  .ranked-item .bar {
    height: 100%;
    border-radius: 3px;
    background: #f59e0b;
    transition: width 0.3s;
  }
  .ranked-item .count {
    font-family: 'JetBrains Mono', monospace;
    color: #888;
    width: 40px;
    text-align: right;
    flex-shrink: 0;
  }
  .ranked-item .pct {
    font-family: 'JetBrains Mono', monospace;
    color: #555;
    font-size: 11px;
    width: 40px;
    text-align: right;
    flex-shrink: 0;
  }
  .score-pill {
    display: inline-block;
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    font-weight: 700;
    padding: 1px 6px;
    border-radius: 4px;
    flex-shrink: 0;
    min-width: 28px;
    text-align: center;
  }

  /* Daily trend bars */
  .trend-bars {
    display: flex;
    align-items: flex-end;
    gap: 4px;
    height: 100px;
    padding-top: 8px;
  }
  .trend-bar {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    height: 100%;
    justify-content: flex-end;
    cursor: pointer;
    transition: opacity 0.15s;
    position: relative;
  }
  .trend-bar:hover { opacity: 0.8; }
  .trend-bar.selected { opacity: 1; }
  .trend-bar.selected::after {
    content: '';
    position: absolute;
    bottom: -4px;
    left: 10%;
    right: 10%;
    height: 2px;
    background: #f59e0b;
    border-radius: 1px;
  }
  .trend-bar .bar {
    width: 100%;
    background: #f59e0b;
    border-radius: 3px 3px 0 0;
    min-height: 2px;
    transition: height 0.3s;
  }
  .trend-bar .bar.secondary { background: #3b82f6; opacity: 0.5; }
  .trend-bar .bar.spike { background: #ef4444; }
  .trend-bar .date {
    font-size: 10px;
    font-family: 'JetBrains Mono', monospace;
    color: #555;
    white-space: nowrap;
  }
  .trend-bar .val {
    font-size: 10px;
    font-family: 'JetBrains Mono', monospace;
    color: #888;
  }

  /* Day detail panel */
  .day-detail {
    margin-top: 16px;
    padding: 16px;
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 8px;
    display: none;
  }
  .day-detail.visible { display: block; }
  .day-detail h3 {
    font-size: 13px;
    font-weight: 700;
    color: #f59e0b;
    margin-bottom: 12px;
    font-family: 'JetBrains Mono', monospace;
  }
  .day-detail .detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 16px;
  }
  .day-detail .detail-section h4 {
    font-size: 10px;
    font-family: 'JetBrains Mono', monospace;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #666;
    margin-bottom: 8px;
  }
  .day-detail .detail-row {
    display: flex;
    justify-content: space-between;
    padding: 3px 0;
    font-size: 12px;
    border-bottom: 1px solid #222;
  }
  .day-detail .detail-row:last-child { border-bottom: none; }
  .day-detail .detail-row .src { color: #aaa; text-transform: capitalize; }
  .day-detail .detail-row .val { color: white; font-family: 'JetBrains Mono', monospace; font-weight: 600; }
  .day-detail .detail-row .pct { color: #666; font-family: 'JetBrains Mono', monospace; font-size: 11px; margin-left: 6px; }

  /* Referrer trend */
  .ref-trend-chart {
    position: relative;
    height: 120px;
    display: flex;
    align-items: flex-end;
    gap: 3px;
  }
  .ref-trend-bar {
    flex: 1;
    display: flex;
    flex-direction: column;
    height: 100%;
    justify-content: flex-end;
  }
  .ref-trend-segment {
    width: 100%;
    min-height: 1px;
    transition: height 0.3s;
  }
  .ref-legend {
    display: flex;
    gap: 16px;
    margin-top: 12px;
    flex-wrap: wrap;
  }
  .ref-legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    font-family: 'JetBrains Mono', monospace;
    color: #888;
  }
  .ref-legend-dot {
    width: 8px;
    height: 8px;
    border-radius: 2px;
    flex-shrink: 0;
  }

  /* Score distribution */
  .score-bar-row {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 6px 0;
  }
  .score-bar-label {
    width: 110px;
    font-size: 12px;
    font-family: 'JetBrains Mono', monospace;
    color: #aaa;
    flex-shrink: 0;
  }
  .score-bar-wrap {
    flex: 1;
    height: 20px;
    background: #1a1a1a;
    border-radius: 4px;
    overflow: hidden;
  }
  .score-bar-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.3s;
  }
  .score-bar-count {
    width: 60px;
    text-align: right;
    font-size: 12px;
    font-family: 'JetBrains Mono', monospace;
    color: #888;
    flex-shrink: 0;
  }
  .score-bar-pct {
    width: 45px;
    text-align: right;
    font-size: 11px;
    font-family: 'JetBrains Mono', monospace;
    color: #555;
    flex-shrink: 0;
  }

  /* Events table */
  .events-table { width: 100%; }
  .events-table td {
    padding: 5px 0;
    font-size: 13px;
    border-bottom: 1px solid #1a1a1a;
  }
  .events-table td:first-child { font-family: 'JetBrains Mono', monospace; color: #aaa; }
  .events-table td:last-child {
    text-align: right;
    font-family: 'JetBrains Mono', monospace;
    color: white;
    font-weight: 600;
  }

  /* Engagement buckets */
  .bucket {
    display: flex;
    justify-content: space-between;
    padding: 5px 0;
    font-size: 13px;
    border-bottom: 1px solid #1a1a1a;
  }
  .bucket .label { color: #aaa; font-family: 'JetBrains Mono', monospace; }
  .bucket .val { color: white; font-weight: 600; font-family: 'JetBrains Mono', monospace; }

  /* Funnel bars */
  .funnel-container {
    display: flex;
    gap: 24px;
    align-items: flex-end;
    flex-wrap: wrap;
  }

  @media (max-width: 768px) {
    .stat-grid, .stat-grid-4 { grid-template-columns: 1fr; }
    .two-col { grid-template-columns: 1fr; }
    .hero .big-number { font-size: 48px; }
    .day-detail .detail-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<!-- Login -->
<div id="login">
  <h1>üç≥ Dashboard</h1>
  <input type="password" id="token-input" placeholder="Enter analytics token..." autofocus>
  <button onclick="tryLogin()">Login</button>
  <div id="login-error" class="error" style="display:none"></div>
</div>

<!-- Dashboard -->
<div id="dashboard">
  <header>
    <h1>üç≥ Am I Cooked? ‚Äî Dashboard</h1>
    <span class="meta" id="last-updated"></span>
  </header>

  <!-- Live visitors -->
  <div class="hero">
    <div class="big-number"><span class="pulse"></span><span id="active-visitors">‚Äî</span></div>
    <div class="label">Active Visitors</div>
    <div class="label" style="margin-top:8px;color:#555">Peak today: <span id="peak-active" style="color:#f59e0b">‚Äî</span></div>
  </div>

  <!-- Today stats with deltas -->
  <div class="stat-grid" id="today-stats">
    <div class="stat-card"><div class="value"><span id="today-pv">‚Äî</span><span id="delta-pv" class="delta"></span></div><div class="label">Page Views Today</div></div>
    <div class="stat-card"><div class="value"><span id="today-uv">‚Äî</span><span id="delta-uv" class="delta"></span></div><div class="label">Unique Visitors Today</div></div>
    <div class="stat-card"><div class="value"><span id="today-api">‚Äî</span><span id="delta-api" class="delta"></span></div><div class="label">Analyses Today</div></div>
  </div>

  <!-- Viral Metrics -->
  <div class="section">
    <h2>üìà Viral Metrics</h2>
    <div class="stat-grid-4" id="viral-metrics">
      <div class="stat-card"><div class="value" id="viral-share-rate">‚Äî</div><div class="label">Share Rate (All Time)</div></div>
      <div class="stat-card"><div class="value" id="viral-share-today">‚Äî</div><div class="label">Share Rate Today</div></div>
      <div class="stat-card"><div class="value" id="viral-analyses-per-visitor">‚Äî</div><div class="label">Analyses / Visitor</div></div>
      <div class="stat-card"><div class="value" id="viral-conversion">‚Äî</div><div class="label">PV ‚Üí Analysis Rate</div></div>
    </div>
  </div>

  <!-- Core Viral Loop Funnel -->
  <div class="section">
    <h2>üîÑ Core Viral Loop</h2>
    <div class="funnel-container" id="viral-funnel"></div>
  </div>

  <!-- Lifetime stats -->
  <div class="stat-grid">
    <div class="stat-card"><div class="value" id="lt-pv">‚Äî</div><div class="label">Lifetime Page Views</div></div>
    <div class="stat-card"><div class="value" id="lt-api">‚Äî</div><div class="label">Lifetime Analyses</div></div>
    <div class="stat-card"><div class="value" id="lt-since">‚Äî</div><div class="label">Tracking Since</div></div>
  </div>

  <!-- Daily trend (clickable) -->
  <div class="section">
    <h2>Daily Trend ‚Äî Analyses & Unique Visitors <span style="color:#444;font-weight:400">(click a day to drill down)</span></h2>
    <div style="display:flex;gap:16px;margin-bottom:8px">
      <span style="display:flex;align-items:center;gap:4px;font-size:11px;font-family:'JetBrains Mono',monospace;color:#888"><span style="width:10px;height:10px;background:#f59e0b;border-radius:2px;display:inline-block"></span> Analyses</span>
      <span style="display:flex;align-items:center;gap:4px;font-size:11px;font-family:'JetBrains Mono',monospace;color:#888"><span style="width:10px;height:10px;background:#3b82f6;opacity:0.5;border-radius:2px;display:inline-block"></span> Unique Visitors</span>
      <span style="display:flex;align-items:center;gap:4px;font-size:11px;font-family:'JetBrains Mono',monospace;color:#888"><span style="width:10px;height:10px;background:#ef4444;border-radius:2px;display:inline-block"></span> Spike (2x+ avg)</span>
    </div>
    <div class="trend-bars" id="trend-bars"></div>
    <div class="day-detail" id="day-detail"></div>
  </div>

  <!-- Referrer Trend (traffic sources over time) -->
  <div class="section">
    <h2>üîç Traffic Sources Over Time ‚Äî What Drives Spikes</h2>
    <div class="ref-trend-chart" id="ref-trend-chart"></div>
    <div class="ref-legend" id="ref-trend-legend"></div>
  </div>

  <!-- Hourly trend -->
  <div class="section">
    <h2>Hourly Trend ‚Äî Last 24h (Analyses)</h2>
    <div class="trend-bars" id="hourly-bars"></div>
  </div>

  <!-- Top jobs (with score pills) -->
  <div class="two-col">
    <div class="section">
      <h2>Top Jobs ‚Äî Today</h2>
      <ul class="ranked-list" id="jobs-today"></ul>
    </div>
    <div class="section">
      <h2>Top Jobs ‚Äî All Time</h2>
      <ul class="ranked-list" id="jobs-alltime"></ul>
    </div>
  </div>

  <!-- Referrers -->
  <div class="two-col">
    <div class="section">
      <h2>Referrers ‚Äî Today</h2>
      <ul class="ranked-list" id="refs-today"></ul>
    </div>
    <div class="section">
      <h2>Referrers ‚Äî All Time</h2>
      <ul class="ranked-list" id="refs-alltime"></ul>
    </div>
  </div>

  <!-- Score Distribution + Score Trend -->
  <div class="two-col">
    <div class="section">
      <h2>üìä Score Distribution</h2>
      <div class="stat-grid" style="margin-bottom:16px;grid-template-columns:1fr 1fr 1fr">
        <div class="stat-card"><div class="value" id="score-avg">‚Äî</div><div class="label">Average Score</div></div>
        <div class="stat-card"><div class="value" id="score-median">‚Äî</div><div class="label">Median Score</div></div>
        <div class="stat-card"><div class="value" id="score-total">‚Äî</div><div class="label">Scored Analyses</div></div>
      </div>
      <div id="score-distribution"></div>
    </div>
    <div class="section">
      <h2>üìà Daily Avg Score ‚Äî Last 14 Days</h2>
      <div class="trend-bars" id="score-trend-bars" style="height:120px"></div>
    </div>
  </div>

  <!-- Events + Engagement -->
  <div class="two-col">
    <div class="section">
      <h2>Button Clicks ‚Äî All Time</h2>
      <table class="events-table" id="events-table"></table>
    </div>
    <div class="section">
      <h2>Visitor Engagement</h2>
      <div id="engagement"></div>
    </div>
  </div>

  <!-- Vibe usage -->
  <div class="section">
    <h2>üé≠ Vibe Usage ‚Äî Tone Distribution</h2>
    <table class="events-table" id="tone-table"></table>
  </div>

  <!-- Leaderboard funnel -->
  <div class="section">
    <h2>üèÜ Leaderboard Funnel</h2>
    <div class="funnel-container" id="leaderboard-funnel"></div>
  </div>

  <!-- Compare mode stats -->
  <div class="section">
    <h2>‚öîÔ∏è Compare Mode</h2>
    <div class="stat-grid-4" id="compare-stats" style="margin-bottom:16px"></div>
    <div class="funnel-container" id="compare-funnel"></div>
  </div>

  <!-- Sticky CTA Performance -->
  <div class="section">
    <h2>üéØ Sticky CTA Performance</h2>
    <div class="stat-grid-4" id="sticky-cta-stats" style="margin-bottom:16px"></div>
    <div class="funnel-container" id="sticky-cta-funnel"></div>
  </div>

  <!-- SEO Pages -->
  <div class="section">
    <h2>üîç SEO Pages</h2>
    <div class="stat-grid" id="seo-stats" style="margin-bottom:16px"></div>
    <div class="funnel-container" id="seo-funnel"></div>
  </div>

  <!-- Company Mode -->
  <div class="section">
    <h2>üè¢ Company Mode</h2>
    <div class="stat-grid-4" id="company-stats" style="margin-bottom:16px"></div>
    <div class="funnel-container" id="company-funnel"></div>
  </div>
</div>

<script>
let TOKEN = localStorage.getItem('aic_dash_token') || ''
let cachedHistory = [] // store daily_history for click-to-drill

function fmt(n) { return (n || 0).toLocaleString() }

// HTML escape
function esc(str) {
  const d = document.createElement('div')
  d.appendChild(document.createTextNode(str))
  return d.innerHTML
}

async function apiFetch(url) {
  const res = await fetch(url, { headers: { 'Authorization': 'Bearer ' + TOKEN } })
  if (res.status === 401) { logout(); throw new Error('Unauthorized') }
  return res.json()
}

function logout() {
  TOKEN = ''
  localStorage.removeItem('aic_dash_token')
  document.getElementById('login').style.display = 'flex'
  document.getElementById('dashboard').style.display = 'none'
}

async function tryLogin() {
  const input = document.getElementById('token-input')
  const err = document.getElementById('login-error')
  TOKEN = input.value.trim()
  try {
    await apiFetch('/api/stats/live')
    localStorage.setItem('aic_dash_token', TOKEN)
    showDashboard()
  } catch {
    err.textContent = 'Invalid token'
    err.style.display = 'block'
  }
}

document.getElementById('token-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') tryLogin()
})

function showDashboard() {
  document.getElementById('login').style.display = 'none'
  document.getElementById('dashboard').style.display = 'block'
  refreshAll()
  setInterval(refreshLive, 10000)
  setInterval(refreshAll, 30000)
}

async function refreshLive() {
  try {
    const data = await apiFetch('/api/stats/live')
    document.getElementById('active-visitors').textContent = data.active_visitors
    document.getElementById('peak-active').textContent = data.peak_active_today || 0
  } catch {}
}

// ‚îÄ‚îÄ Delta helper ‚îÄ‚îÄ
function renderDelta(elId, todayVal, yesterdayVal) {
  const el = document.getElementById(elId)
  if (!el || yesterdayVal == null || yesterdayVal === 0) {
    el.textContent = ''
    return
  }
  const pct = Math.round(((todayVal - yesterdayVal) / yesterdayVal) * 100)
  if (pct > 0) {
    el.className = 'delta up'
    el.textContent = `+${pct}%`
  } else if (pct < 0) {
    el.className = 'delta down'
    el.textContent = `${pct}%`
  } else {
    el.className = 'delta flat'
    el.textContent = '0%'
  }
}

// ‚îÄ‚îÄ Score color helpers ‚îÄ‚îÄ
function scoreColor(score) {
  if (score <= 20) return '#3b82f6'
  if (score <= 40) return '#22c55e'
  if (score <= 60) return '#f59e0b'
  if (score <= 80) return '#f97316'
  return '#ef4444'
}
function scoreBg(score) {
  if (score <= 20) return 'rgba(59,130,246,0.2)'
  if (score <= 40) return 'rgba(34,197,94,0.2)'
  if (score <= 60) return 'rgba(245,158,11,0.2)'
  if (score <= 80) return 'rgba(249,115,22,0.2)'
  return 'rgba(239,68,68,0.2)'
}

// ‚îÄ‚îÄ Referrer source colors ‚îÄ‚îÄ
const SOURCE_COLORS = {
  'twitter/x': '#1d9bf0',
  'reddit': '#ff4500',
  'linkedin': '#0077b5',
  'google': '#34a853',
  'direct': '#f59e0b',
  'shared-link': '#a855f7',
  'facebook': '#1877f2',
  'instagram': '#e4405f',
  'tiktok': '#00f2ea',
  'youtube': '#ff0000',
  'discord': '#5865f2',
  'threads': '#000000',
  'bluesky': '#0085ff',
}
function getSourceColor(source, idx) {
  return SOURCE_COLORS[source] || ['#8b5cf6','#ec4899','#14b8a6','#f97316','#6366f1','#a855f7'][idx % 6]
}

async function refreshAll() {
  try {
    const [stats, jobsToday, jobsAll, refsToday, refsAll, events, eventsToday, visitors, hourly, tones, scores, scoreTrend, refTrend] = await Promise.all([
      apiFetch('/api/stats'),
      apiFetch('/api/stats/jobs?period=today&limit=15'),
      apiFetch('/api/stats/jobs?period=all&limit=15'),
      apiFetch('/api/stats/referrers?period=today'),
      apiFetch('/api/stats/referrers?period=all'),
      apiFetch('/api/stats/events?period=all'),
      apiFetch('/api/stats/events?period=today'),
      apiFetch('/api/stats/visitors?period=all'),
      apiFetch('/api/stats/hourly?hours=24'),
      apiFetch('/api/stats/tones?period=all'),
      apiFetch('/api/stats/scores'),
      apiFetch('/api/stats/score-trend?days=14'),
      apiFetch('/api/stats/referrer-trend?days=30'),
    ])

    cachedHistory = stats.daily_history || []

    // Live
    document.getElementById('active-visitors').textContent = stats.realtime.active_visitors
    document.getElementById('peak-active').textContent = stats.realtime.peak_active_today || 0

    // Today
    document.getElementById('today-pv').textContent = fmt(stats.today.page_views)
    document.getElementById('today-uv').textContent = fmt(stats.today.unique_visitors)
    document.getElementById('today-api').textContent = fmt(stats.today.api_calls)

    // Deltas (yesterday = second-to-last in daily_history)
    const history = stats.daily_history || []
    const yesterday = history.length >= 2 ? history[history.length - 2] : null
    if (yesterday) {
      renderDelta('delta-pv', stats.today.page_views, yesterday.page_views)
      renderDelta('delta-uv', stats.today.unique_visitors, yesterday.unique_visitors)
      renderDelta('delta-api', stats.today.api_calls, yesterday.api_calls)
    }

    // Viral Metrics
    renderViralMetrics(stats, events, eventsToday)

    // Core Viral Loop
    renderViralFunnel(stats, events)

    // Lifetime
    document.getElementById('lt-pv').textContent = fmt(stats.lifetime.total_page_views)
    document.getElementById('lt-api').textContent = fmt(stats.lifetime.total_api_calls)
    const since = new Date(stats.lifetime.tracking_since)
    document.getElementById('lt-since').textContent = since.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })

    // Trend (clickable, dual bars)
    renderTrend(stats.daily_history)

    // Referrer trend
    renderReferrerTrend(refTrend)

    // Jobs (with score pills)
    renderRankedList('jobs-today', jobsToday.titles, 'count', true)
    renderRankedList('jobs-alltime', jobsAll.titles, 'count', true)

    // Referrers
    renderRankedList('refs-today', refsToday.referrers, 'count', false)
    renderRankedList('refs-alltime', refsAll.referrers, 'count', false)

    // Score distribution
    renderScoreDistribution(scores)

    // Score trend
    renderScoreTrend(scoreTrend)

    // Events
    renderEvents(events.events)

    // Leaderboard funnel
    renderLeaderboardFunnel(events.events)

    // Compare mode stats + funnel
    renderCompareStats(events.events, eventsToday.events, stats)
    renderCompareFunnel(events.events)
    renderStickyCTAStats(events.events, eventsToday.events)
    renderStickyCTAFunnel(events.events)
    renderSeoStats(events.events, eventsToday.events)
    renderSeoFunnel(events.events)
    renderCompanyStats(events.events, eventsToday.events)
    renderCompanyFunnel(events.events)

    // Engagement
    renderEngagement(visitors)

    // Hourly trend
    renderHourlyTrend(hourly)

    // Tone/vibe usage
    renderTones(tones)

    // Timestamp
    document.getElementById('last-updated').textContent = 'Updated ' + new Date().toLocaleTimeString()

  } catch (e) { console.error('Refresh failed:', e) }
}

// ‚îÄ‚îÄ Viral Metrics ‚îÄ‚îÄ
function renderViralMetrics(stats, allEvents, todayEvents) {
  const allShares = (allEvents.events || []).filter(e => e.action.includes('share_') || e.action.includes('share_')).reduce((s, e) => s + e.count, 0)
  const todayShares = (todayEvents.events || []).filter(e => e.action.includes('share_') || e.action.includes('share_')).reduce((s, e) => s + e.count, 0)

  const ltAnalyses = stats.lifetime.total_api_calls || 0
  const todayAnalyses = stats.today.api_calls || 0
  const todayVisitors = stats.today.unique_visitors || 0

  const ltShareRate = ltAnalyses > 0 ? (allShares / ltAnalyses * 100).toFixed(1) + '%' : '‚Äî'
  const todayShareRate = todayAnalyses > 0 ? (todayShares / todayAnalyses * 100).toFixed(1) + '%' : '‚Äî'
  const analysesPerVisitor = todayVisitors > 0 ? (todayAnalyses / todayVisitors).toFixed(1) : '‚Äî'
  const pvToAnalysis = stats.today.page_views > 0 ? (todayAnalyses / stats.today.page_views * 100).toFixed(1) + '%' : '‚Äî'

  document.getElementById('viral-share-rate').textContent = ltShareRate
  document.getElementById('viral-share-today').textContent = todayShareRate
  document.getElementById('viral-analyses-per-visitor').textContent = analysesPerVisitor
  document.getElementById('viral-conversion').textContent = pvToAnalysis
}

// ‚îÄ‚îÄ Core Viral Loop Funnel ‚îÄ‚îÄ
function renderViralFunnel(stats, events) {
  const el = document.getElementById('viral-funnel')
  const pv = stats.lifetime.total_page_views || 0
  const analyses = stats.lifetime.total_api_calls || 0
  const shares = (events.events || []).filter(e => e.action.includes('share')).reduce((s, e) => s + e.count, 0)

  if (pv === 0) {
    el.innerHTML = '<div style="color:#555;font-size:13px">No data yet</div>'
    return
  }

  const max = Math.max(pv, 1)
  const items = [
    { label: 'Page Views', value: pv, color: '#3b82f6' },
    { label: 'Analyses', value: analyses, color: '#f59e0b' },
    { label: 'Shares', value: shares, color: '#22c55e' },
  ]

  el.innerHTML = items.map((item, i) => {
    const height = Math.max((item.value / max) * 120, 4)
    const conv = i > 0 ? ` (${(item.value / items[i-1].value * 100).toFixed(1)}%)` : ''
    return `<div style="flex:1;text-align:center;min-width:80px">
      <div style="font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:700;color:white;margin-bottom:4px">${fmt(item.value)}</div>
      <div style="height:${height}px;background:${item.color};border-radius:4px 4px 0 0;margin:0 auto;width:80%;opacity:0.8"></div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:#888;margin-top:8px;text-transform:uppercase;letter-spacing:1px">${item.label}${conv}</div>
    </div>`
  }).join('<div style="color:#555;font-size:18px;align-self:center">‚Üí</div>')
}

// ‚îÄ‚îÄ Daily Trend (clickable, dual bars, spike detection) ‚îÄ‚îÄ
function renderTrend(history) {
  const el = document.getElementById('trend-bars')
  const recent = history.slice(-14)
  const avgApiCalls = recent.reduce((s, d) => s + d.api_calls, 0) / Math.max(recent.length, 1)
  const maxAnalyses = Math.max(...recent.map(d => d.api_calls), 1)
  const maxVisitors = Math.max(...recent.map(d => d.unique_visitors || 0), 1)
  const maxVal = Math.max(maxAnalyses, maxVisitors)

  el.innerHTML = recent.map((d, i) => {
    const analysisPct = (d.api_calls / maxVal * 100)
    const visitorPct = ((d.unique_visitors || 0) / maxVal * 100)
    const isSpike = d.api_calls > avgApiCalls * 2
    const date = new Date(d.date + 'T12:00:00')
    const label = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
    const barClass = isSpike ? 'bar spike' : 'bar'
    return `<div class="trend-bar" onclick="loadDayDetail('${d.date}', this)" title="${label}: ${fmt(d.api_calls)} analyses, ${fmt(d.unique_visitors || 0)} visitors">
      <div class="val">${fmt(d.api_calls)}</div>
      <div style="display:flex;gap:2px;width:100%;align-items:flex-end;height:80%">
        <div class="${barClass}" style="height:${Math.max(analysisPct, 2)}%;flex:1"></div>
        <div class="bar secondary" style="height:${Math.max(visitorPct, 2)}%;flex:1"></div>
      </div>
      <div class="date">${label}</div>
    </div>`
  }).join('')
}

// ‚îÄ‚îÄ Day detail (click a spike) ‚îÄ‚îÄ
async function loadDayDetail(date, barEl) {
  const panel = document.getElementById('day-detail')

  // Toggle selected state
  document.querySelectorAll('.trend-bar.selected').forEach(b => b.classList.remove('selected'))
  if (barEl) barEl.classList.add('selected')

  // If clicking same day, toggle off
  if (panel.dataset.date === date && panel.classList.contains('visible')) {
    panel.classList.remove('visible')
    panel.dataset.date = ''
    if (barEl) barEl.classList.remove('selected')
    return
  }

  panel.dataset.date = date
  panel.innerHTML = '<h3>Loading...</h3>'
  panel.classList.add('visible')

  try {
    const data = await apiFetch(`/api/stats/day/${date}`)
    const dateLabel = new Date(date + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })

    // Find this day in history for context
    const dayIdx = cachedHistory.findIndex(d => d.date === date)
    const prevDay = dayIdx > 0 ? cachedHistory[dayIdx - 1] : null
    const dayGrowth = prevDay && prevDay.api_calls > 0
      ? Math.round(((data.stats.api_calls - prevDay.api_calls) / prevDay.api_calls) * 100)
      : null

    const growthHtml = dayGrowth !== null
      ? `<span class="delta ${dayGrowth > 0 ? 'up' : dayGrowth < 0 ? 'down' : 'flat'}" style="font-size:14px">${dayGrowth > 0 ? '+' : ''}${dayGrowth}% vs prev day</span>`
      : ''

    let html = `<h3>${dateLabel} ${growthHtml}</h3>`
    html += `<div style="display:flex;gap:24px;margin-bottom:16px;flex-wrap:wrap">`
    html += `<div style="font-size:12px;font-family:'JetBrains Mono',monospace"><span style="color:#666">PV</span> <span style="color:white;font-weight:600">${fmt(data.stats.page_views)}</span></div>`
    html += `<div style="font-size:12px;font-family:'JetBrains Mono',monospace"><span style="color:#666">UV</span> <span style="color:white;font-weight:600">${fmt(data.stats.unique_visitors)}</span></div>`
    html += `<div style="font-size:12px;font-family:'JetBrains Mono',monospace"><span style="color:#666">Analyses</span> <span style="color:white;font-weight:600">${fmt(data.stats.api_calls)}</span></div>`
    html += `<div style="font-size:12px;font-family:'JetBrains Mono',monospace"><span style="color:#666">Peak Active</span> <span style="color:white;font-weight:600">${fmt(data.stats.peak_active)}</span></div>`
    html += `</div>`

    html += `<div class="detail-grid">`

    // Referrers column
    html += `<div class="detail-section"><h4>Traffic Sources</h4>`
    if (data.referrers.length === 0) {
      html += `<div style="color:#555;font-size:12px">No referrer data</div>`
    } else {
      data.referrers.forEach(r => {
        const color = getSourceColor(r.source, 0)
        html += `<div class="detail-row"><span class="src"><span style="display:inline-block;width:6px;height:6px;border-radius:2px;background:${color};margin-right:4px"></span>${esc(r.source)}</span><span><span class="val">${fmt(r.count)}</span><span class="pct">${r.pct}%</span></span></div>`
      })
    }
    html += `</div>`

    // Top jobs column
    html += `<div class="detail-section"><h4>Top Jobs</h4>`
    if (data.top_jobs.length === 0) {
      html += `<div style="color:#555;font-size:12px">No job data</div>`
    } else {
      data.top_jobs.slice(0, 8).forEach(j => {
        html += `<div class="detail-row"><span class="src">${esc(j.title)}</span><span class="val">${fmt(j.count)}</span></div>`
      })
    }
    html += `</div>`

    // Events column
    html += `<div class="detail-section"><h4>Events</h4>`
    if (data.events.length === 0) {
      html += `<div style="color:#555;font-size:12px">No event data</div>`
    } else {
      const eventLabels = {
        share_primary: 'üìã Share',
        share_twitter: 'ùïè Post on X',
        share_linkedin: 'üíº LinkedIn',
        try_again: 'üîÑ Try Again',
        view_leaderboard: 'üèÜ Leaderboard',
        compare_submit: '‚öîÔ∏è Compare',
        compare_share_primary: '‚öîÔ∏èüìã Compare Share',
        compare_share_twitter: '‚öîÔ∏èùïè Compare X',
        compare_share_linkedin: '‚öîÔ∏èüíº Compare LinkedIn',
        sticky_cta_impression: 'üéØ CTA Shown',
        sticky_cta_dismiss: '‚ùå CTA Dismissed',
        sticky_cta_autodismiss: '‚è± CTA Auto-Dismissed',
        sticky_cta_share: 'üéØ Challenge Share',
        sticky_cta_twitter: 'üéØùïè Challenge X',
        sticky_cta_linkedin: 'üéØüíº Challenge LinkedIn',
        seo_page_view: 'üîç SEO View',
        seo_page_cta_click: 'üîç SEO CTA',
        seo_page_related_click: 'üîç SEO Related',
        company_analyze: 'üè¢ Company Analyze',
        company_share_primary: 'üè¢ Company Share',
        company_share_twitter: 'üè¢ Company X',
        company_share_linkedin: 'üè¢ Company LinkedIn',
        company_try_again: 'üè¢ Company Retry',
        company_dimension_expand: 'üè¢ Dimension Expand',
        company_crosslink_job: 'üè¢‚Üí Job Cross-link',
      }
      data.events.slice(0, 8).forEach(e => {
        const label = eventLabels[e.action] || e.action
        html += `<div class="detail-row"><span class="src">${label}</span><span class="val">${fmt(e.count)}</span></div>`
      })
    }
    html += `</div>`

    html += `</div>`
    panel.innerHTML = html
  } catch (err) {
    panel.innerHTML = `<h3 style="color:#ef4444">Failed to load data for ${date}</h3>`
  }
}

// ‚îÄ‚îÄ Referrer Trend (traffic sources over time) ‚îÄ‚îÄ
function renderReferrerTrend(data) {
  const chartEl = document.getElementById('ref-trend-chart')
  const legendEl = document.getElementById('ref-trend-legend')

  if (!data || !data.data || data.data.length === 0) {
    chartEl.innerHTML = '<div style="color:#555;font-size:13px;padding:8px 0">No referrer trend data yet</div>'
    legendEl.innerHTML = ''
    return
  }

  const sources = data.sources || []
  const maxTotal = Math.max(...data.data.map(d => {
    return sources.reduce((s, src) => s + (d.sources[src] || 0), 0)
  }), 1)

  chartEl.innerHTML = data.data.map(d => {
    let segments = ''
    sources.forEach((src, i) => {
      const val = d.sources[src] || 0
      const pct = (val / maxTotal * 100)
      const color = getSourceColor(src, i)
      segments += `<div class="ref-trend-segment" style="height:${Math.max(pct, 0)}%;background:${color};opacity:0.8" title="${src}: ${fmt(val)}"></div>`
    })
    return `<div class="ref-trend-bar" title="${d.date}">${segments}</div>`
  }).join('')

  legendEl.innerHTML = sources.map((src, i) => {
    const color = getSourceColor(src, i)
    const total = data.data.reduce((s, d) => s + (d.sources[src] || 0), 0)
    return `<div class="ref-legend-item"><span class="ref-legend-dot" style="background:${color}"></span>${esc(src)} (${fmt(total)})</div>`
  }).join('')
}

// ‚îÄ‚îÄ Score Distribution ‚îÄ‚îÄ
function renderScoreDistribution(data) {
  document.getElementById('score-avg').textContent = data.avg != null ? data.avg : '‚Äî'
  document.getElementById('score-median').textContent = data.median != null ? data.median : '‚Äî'
  document.getElementById('score-total').textContent = fmt(data.total)

  const el = document.getElementById('score-distribution')
  if (!data.distribution || data.distribution.length === 0) {
    el.innerHTML = '<div style="color:#555;font-size:13px">No score data yet</div>'
    return
  }

  const maxCount = Math.max(...data.distribution.map(d => d.count), 1)
  const bucketColors = {
    'Raw': '#3b82f6',
    'Medium Rare': '#22c55e',
    'Medium': '#f59e0b',
    'Well Done': '#f97316',
    'Fully Cooked': '#ef4444',
  }
  const bucketEmoji = {
    'Raw': 'üßä',
    'Medium Rare': 'ü•©',
    'Medium': 'üç≥',
    'Well Done': 'üî•',
    'Fully Cooked': 'üíÄ',
  }

  el.innerHTML = data.distribution.map(d => {
    const pct = (d.count / maxCount * 100)
    const color = bucketColors[d.bucket] || '#666'
    const emoji = bucketEmoji[d.bucket] || ''
    return `<div class="score-bar-row">
      <span class="score-bar-label">${emoji} ${d.bucket}</span>
      <div class="score-bar-wrap"><div class="score-bar-fill" style="width:${pct}%;background:${color}"></div></div>
      <span class="score-bar-count">${fmt(d.count)}</span>
      <span class="score-bar-pct">${d.pct}%</span>
    </div>`
  }).join('')
}

// ‚îÄ‚îÄ Daily Score Trend ‚îÄ‚îÄ
function renderScoreTrend(data) {
  const el = document.getElementById('score-trend-bars')
  if (!data || !data.data || data.data.length === 0) {
    el.innerHTML = '<div style="color:#555;font-size:13px;padding:8px 0">No score trend data yet</div>'
    return
  }

  el.innerHTML = data.data.map(d => {
    const pct = d.avg_score // score is already 0-100, use as percentage
    const date = new Date(d.date + 'T12:00:00')
    const label = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
    const color = scoreColor(d.avg_score)
    return `<div class="trend-bar" title="${label}: avg ${d.avg_score}, ${fmt(d.count)} analyses" style="cursor:default">
      <div class="val" style="color:${color};font-weight:600">${d.avg_score}</div>
      <div class="bar" style="height:${Math.max(pct, 2)}%;background:${color};opacity:0.7"></div>
      <div class="date">${label}</div>
    </div>`
  }).join('')
}

// ‚îÄ‚îÄ Ranked list (with optional score pills) ‚îÄ‚îÄ
function renderRankedList(elId, items, countKey, showScores = false) {
  const el = document.getElementById(elId)
  if (!items || items.length === 0) {
    el.innerHTML = '<li style="color:#555;font-size:13px;padding:8px 0">No data yet</li>'
    return
  }
  const max = Math.max(...items.map(i => i[countKey]), 1)
  el.innerHTML = items.map((item, idx) => {
    const pct = (item[countKey] / max * 100)
    const title = esc(item.title || item.source || '‚Äî')
    const pctLabel = item.pct ? `${item.pct}%` : ''
    const scorePill = showScores && item.avg_score != null
      ? `<span class="score-pill" style="background:${scoreBg(item.avg_score)};color:${scoreColor(item.avg_score)}">${item.avg_score}</span>`
      : ''
    return `<li class="ranked-item">
      <span class="rank">${idx + 1}</span>
      <span class="title">${title}</span>
      ${scorePill}
      <span class="bar-wrap"><span class="bar" style="width:${pct}%"></span></span>
      <span class="count">${fmt(item[countKey])}</span>
      <span class="pct">${pctLabel}</span>
    </li>`
  }).join('')
}

function renderEvents(events) {
  const el = document.getElementById('events-table')
  if (!events || events.length === 0) {
    el.innerHTML = '<tr><td colspan="2" style="color:#555">No data yet</td></tr>'
    return
  }
  const labels = {
    share_primary: 'üìã Share / Copy',
    share_twitter: 'ùïè Post on X',
    share_linkedin: 'üíº LinkedIn',
    try_again: 'üîÑ Try Again',
    view_leaderboard: 'üèÜ View Leaderboard',
    leaderboard_tab: 'üîÄ Leaderboard Tab Switch',
    leaderboard_job_click: 'üëÜ Leaderboard Job Click',
    compare_submit: '‚öîÔ∏è Compare Submitted',
    compare_share_primary: '‚öîÔ∏èüìã Compare Share / Copy',
    compare_share_twitter: '‚öîÔ∏èùïè Compare Post on X',
    compare_share_linkedin: '‚öîÔ∏èüíº Compare LinkedIn',
    sticky_cta_impression: 'üéØ Sticky CTA Shown',
    sticky_cta_dismiss: '‚ùå Sticky CTA Dismissed',
    sticky_cta_autodismiss: '‚è± Sticky CTA Auto-Dismissed',
    sticky_cta_share: 'üéØ Challenge Share',
    sticky_cta_twitter: 'üéØùïè Challenge Post on X',
    sticky_cta_linkedin: 'üéØüíº Challenge LinkedIn',
    seo_page_view: 'üîç SEO Page View',
    seo_page_cta_click: 'üîç SEO CTA Click',
    seo_page_related_click: 'üîç SEO Related Job Click',
    company_analyze: 'üè¢ Company Analyze',
    company_share_primary: 'üè¢ Company Share / Copy',
    company_share_twitter: 'üè¢ùïè Company Post on X',
    company_share_linkedin: 'üè¢üíº Company LinkedIn',
    company_try_again: 'üè¢ Company Try Again',
    company_dimension_expand: 'üè¢ Dimension Expand',
    company_crosslink_job: 'üè¢‚Üí Job Cross-link',
  }
  el.innerHTML = events.map(e =>
    `<tr><td>${labels[e.action] || esc(e.action)}</td><td>${fmt(e.count)}</td></tr>`
  ).join('')
}

function renderEngagement(data) {
  const el = document.getElementById('engagement')
  if (!data || !data.distribution) {
    el.innerHTML = '<div style="color:#555;font-size:13px">No data yet</div>'
    return
  }
  const d = data.distribution
  el.innerHTML = `
    <div class="bucket"><span class="label">1 search</span><span class="val">${d['1'] || 0} visitors</span></div>
    <div class="bucket"><span class="label">2-5 searches</span><span class="val">${d['2-5'] || 0} visitors</span></div>
    <div class="bucket"><span class="label">6-10 searches</span><span class="val">${d['6-10'] || 0} visitors</span></div>
    <div class="bucket"><span class="label">11-20 searches</span><span class="val">${d['11-20'] || 0} visitors</span></div>
    <div class="bucket"><span class="label">20+ searches</span><span class="val">${d['20+'] || 0} visitors</span></div>
    <div style="margin-top:12px;font-size:12px;color:#666;font-family:'JetBrains Mono',monospace">
      ${data.unique_analysts || 0} unique analysts tracked
    </div>
  `
}

function renderFunnel(elId, items, baseVal) {
  const el = document.getElementById(elId)
  const max = Math.max(baseVal || items[0]?.value || 1, 1)

  if (items.every(i => i.value === 0)) {
    el.innerHTML = '<div style="color:#555;font-size:13px">No activity yet</div>'
    return
  }

  el.innerHTML = items.map((item, i) => {
    const height = Math.max((item.value / max) * 120, 4)
    const convPct = i > 0 && items[0].value > 0 ? ` (${Math.round(item.value / items[0].value * 100)}%)` : ''
    return `<div style="flex:1;text-align:center;min-width:80px">
      <div style="font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:700;color:white;margin-bottom:4px">${fmt(item.value)}</div>
      <div style="height:${height}px;background:${item.color};border-radius:4px 4px 0 0;margin:0 auto;width:80%;opacity:0.8"></div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:#888;margin-top:8px;text-transform:uppercase;letter-spacing:1px">${item.label}${convPct}</div>
    </div>`
  }).join('<div style="color:#555;font-size:18px;align-self:center">‚Üí</div>')
}

function renderLeaderboardFunnel(events) {
  const views = (events.find(e => e.action === 'view_leaderboard') || {}).count || 0
  const tabs = (events.find(e => e.action === 'leaderboard_tab') || {}).count || 0
  const clicks = (events.find(e => e.action === 'leaderboard_job_click') || {}).count || 0
  renderFunnel('leaderboard-funnel', [
    { label: 'Viewed', value: views, color: '#f59e0b' },
    { label: 'Tab Switches', value: tabs, color: '#3b82f6' },
    { label: 'Job Clicks', value: clicks, color: '#22c55e' },
  ], views)
}

function renderCompareStats(allEvents, todayEvents, stats) {
  const el = document.getElementById('compare-stats')
  const ltCompares = (allEvents.find(e => e.action === 'compare_submit') || {}).count || 0
  const todayCompares = ((todayEvents || []).find(e => e.action === 'compare_submit') || {}).count || 0
  const ltAnalyses = stats.lifetime.total_api_calls || 0
  const ltCompareShares = ['compare_share_primary', 'compare_share_twitter', 'compare_share_linkedin']
    .reduce((s, a) => s + ((allEvents.find(e => e.action === a) || {}).count || 0), 0)

  // Each compare = 2 API calls, so compare-driven analyses = compares * 2
  const comparePct = ltAnalyses > 0 ? (ltCompares * 2 / ltAnalyses * 100).toFixed(1) + '%' : '‚Äî'
  const compareShareRate = ltCompares > 0 ? (ltCompareShares / ltCompares * 100).toFixed(1) + '%' : '‚Äî'

  el.innerHTML = `
    <div class="stat-card"><div class="value" style="color:#a855f7">${fmt(ltCompares)}</div><div class="label">Total Comparisons</div></div>
    <div class="stat-card"><div class="value">${fmt(todayCompares)}</div><div class="label">Comparisons Today</div></div>
    <div class="stat-card"><div class="value">${comparePct}</div><div class="label">% of Analyses (2x each)</div></div>
    <div class="stat-card"><div class="value">${compareShareRate}</div><div class="label">Compare Share Rate</div></div>
  `
}

function renderCompareFunnel(events) {
  const submits = (events.find(e => e.action === 'compare_submit') || {}).count || 0
  const shares = (events.find(e => e.action === 'compare_share_primary') || {}).count || 0
  const twitter = (events.find(e => e.action === 'compare_share_twitter') || {}).count || 0
  const linkedin = (events.find(e => e.action === 'compare_share_linkedin') || {}).count || 0
  renderFunnel('compare-funnel', [
    { label: 'Comparisons', value: submits, color: '#a855f7' },
    { label: 'Copy/Share', value: shares, color: '#3b82f6' },
    { label: 'Post on X', value: twitter, color: '#6b7280' },
    { label: 'LinkedIn', value: linkedin, color: '#0077b5' },
  ], submits)
}

function renderStickyCTAStats(allEvents, todayEvents) {
  const el = document.getElementById('sticky-cta-stats')
  const impressions = (allEvents.find(e => e.action === 'sticky_cta_impression') || {}).count || 0
  const shares = (allEvents.find(e => e.action === 'sticky_cta_share') || {}).count || 0
  const dismissed = (allEvents.find(e => e.action === 'sticky_cta_dismiss') || {}).count || 0
  const autoDismissed = (allEvents.find(e => e.action === 'sticky_cta_autodismiss') || {}).count || 0

  const convRate = impressions > 0 ? (shares / impressions * 100).toFixed(1) + '%' : '‚Äî'
  const dismissRate = impressions > 0 ? ((dismissed + autoDismissed) / impressions * 100).toFixed(1) + '%' : '‚Äî'

  el.innerHTML = `
    <div class="stat-card"><div class="value" style="color:#f59e0b">${fmt(impressions)}</div><div class="label">Impressions</div></div>
    <div class="stat-card"><div class="value" style="color:#22c55e">${fmt(shares)}</div><div class="label">Challenge Shares</div></div>
    <div class="stat-card"><div class="value" style="color:#22c55e">${convRate}</div><div class="label">CTA Conversion Rate</div></div>
    <div class="stat-card"><div class="value" style="color:#6b7280">${dismissRate}</div><div class="label">Dismiss Rate</div></div>
  `
}

function renderStickyCTAFunnel(events) {
  const impressions = (events.find(e => e.action === 'sticky_cta_impression') || {}).count || 0
  const shares = (events.find(e => e.action === 'sticky_cta_share') || {}).count || 0
  const twitter = (events.find(e => e.action === 'sticky_cta_twitter') || {}).count || 0
  const linkedin = (events.find(e => e.action === 'sticky_cta_linkedin') || {}).count || 0
  renderFunnel('sticky-cta-funnel', [
    { label: 'Impressions', value: impressions, color: '#f59e0b' },
    { label: 'Challenge Share', value: shares, color: '#22c55e' },
    { label: 'Post on X', value: twitter, color: '#6b7280' },
    { label: 'LinkedIn', value: linkedin, color: '#0077b5' },
  ], impressions)
}

function renderSeoStats(allEvents, todayEvents) {
  const el = document.getElementById('seo-stats')
  const views = (allEvents.find(e => e.action === 'seo_page_view') || {}).count || 0
  const ctaClicks = (allEvents.find(e => e.action === 'seo_page_cta_click') || {}).count || 0
  const relatedClicks = (allEvents.find(e => e.action === 'seo_page_related_click') || {}).count || 0
  const todayViews = ((todayEvents || []).find(e => e.action === 'seo_page_view') || {}).count || 0
  const ctaRate = views > 0 ? (ctaClicks / views * 100).toFixed(1) + '%' : '‚Äî'

  el.innerHTML = `
    <div class="stat-card"><div class="value" style="color:#3b82f6">${fmt(views)}</div><div class="label">SEO Page Views</div></div>
    <div class="stat-card"><div class="value">${fmt(todayViews)}</div><div class="label">SEO Views Today</div></div>
    <div class="stat-card"><div class="value" style="color:#22c55e">${ctaRate}</div><div class="label">CTA Click Rate</div></div>
  `
}

function renderSeoFunnel(events) {
  const views = (events.find(e => e.action === 'seo_page_view') || {}).count || 0
  const ctaClicks = (events.find(e => e.action === 'seo_page_cta_click') || {}).count || 0
  const relatedClicks = (events.find(e => e.action === 'seo_page_related_click') || {}).count || 0
  renderFunnel('seo-funnel', [
    { label: 'SEO Views', value: views, color: '#3b82f6' },
    { label: 'CTA Clicks', value: ctaClicks, color: '#22c55e' },
    { label: 'Related Clicks', value: relatedClicks, color: '#a855f7' },
  ], views)
}

function renderCompanyStats(allEvents, todayEvents) {
  const el = document.getElementById('company-stats')
  const analyzes = (allEvents.find(e => e.action === 'company_analyze') || {}).count || 0
  const shares = (allEvents.find(e => e.action === 'company_share_primary') || {}).count || 0
  const dimExpands = (allEvents.find(e => e.action === 'company_dimension_expand') || {}).count || 0
  const todayAnalyzes = ((todayEvents || []).find(e => e.action === 'company_analyze') || {}).count || 0
  const shareRate = analyzes > 0 ? (shares / analyzes * 100).toFixed(1) + '%' : '‚Äî'
  const expandRate = analyzes > 0 ? (dimExpands / analyzes * 100).toFixed(1) + '%' : '‚Äî'

  el.innerHTML = `
    <div class="stat-card"><div class="value" style="color:#3b82f6">${fmt(analyzes)}</div><div class="label">Company Analyses</div></div>
    <div class="stat-card"><div class="value">${fmt(todayAnalyzes)}</div><div class="label">Companies Today</div></div>
    <div class="stat-card"><div class="value" style="color:#22c55e">${shareRate}</div><div class="label">Share Rate</div></div>
    <div class="stat-card"><div class="value" style="color:#a855f7">${expandRate}</div><div class="label">Dimension Expand Rate</div></div>
  `
}

function renderCompanyFunnel(events) {
  const analyzes = (events.find(e => e.action === 'company_analyze') || {}).count || 0
  const shares = (events.find(e => e.action === 'company_share_primary') || {}).count || 0
  const twitter = (events.find(e => e.action === 'company_share_twitter') || {}).count || 0
  const linkedin = (events.find(e => e.action === 'company_share_linkedin') || {}).count || 0
  renderFunnel('company-funnel', [
    { label: 'Analyses', value: analyzes, color: '#3b82f6' },
    { label: 'Share / Copy', value: shares, color: '#22c55e' },
    { label: 'Post on X', value: twitter, color: '#a855f7' },
    { label: 'LinkedIn', value: linkedin, color: '#f59e0b' },
  ], analyzes)
}

function renderHourlyTrend(data) {
  const el = document.getElementById('hourly-bars')
  if (!data || !data.data || data.data.length === 0) {
    el.innerHTML = '<div style="color:#555;font-size:13px;padding:8px 0">No hourly data yet</div>'
    return
  }

  const now = new Date()
  const hours = []
  for (let i = 23; i >= 0; i--) {
    const d = new Date(now)
    d.setMinutes(0, 0, 0)
    d.setHours(d.getHours() - i)
    hours.push(d.toISOString().slice(0, 13))
  }

  const byHour = {}
  data.data.forEach(d => {
    const key = d.hour.slice(0, 13)
    byHour[key] = d.analyses
  })

  const filled = hours.map(h => ({
    hour: h,
    analyses: byHour[h] || 0,
  }))

  const maxVal = Math.max(...filled.map(d => d.analyses), 1)

  el.innerHTML = filled.map(d => {
    const pct = (d.analyses / maxVal * 100)
    const dt = new Date(d.hour + ':00:00')
    const label = dt.toLocaleTimeString('en-US', { hour: 'numeric', hour12: true }).toLowerCase()
    return `<div class="trend-bar" style="cursor:default">
      <div class="val">${d.analyses || ''}</div>
      <div class="bar" style="height:${Math.max(pct, 2)}%;background:#3b82f6"></div>
      <div class="date">${label}</div>
    </div>`
  }).join('')
}

function renderTones(data) {
  const el = document.getElementById('tone-table')
  if (!data || !data.tones || data.tones.length === 0) {
    el.innerHTML = '<tr><td colspan="3" style="color:#555">No tone data yet</td></tr>'
    return
  }

  const labels = {
    'default': 'üéØ Default',
    'chaos_agent': 'üåÄ Chaos Agent',
    'corporate_shill': 'üíº Corporate Shill',
    'michael_scott': 'üé¨ Michael Scott',
  }

  el.innerHTML = `<tr style="border-bottom:1px solid #2a2a2a">
    <td style="color:#666;font-size:11px;text-transform:uppercase;letter-spacing:1px;padding-bottom:8px">Tone</td>
    <td style="color:#666;font-size:11px;text-transform:uppercase;letter-spacing:1px;text-align:right;padding-bottom:8px">Count</td>
    <td style="color:#666;font-size:11px;text-transform:uppercase;letter-spacing:1px;text-align:right;padding-bottom:8px">Share</td>
  </tr>` + data.tones.map(t => {
    const label = labels[t.tone] || esc(t.tone)
    return `<tr>
      <td>${label}</td>
      <td style="text-align:right;font-family:'JetBrains Mono',monospace;color:white;font-weight:600">${fmt(t.count)}</td>
      <td style="text-align:right;font-family:'JetBrains Mono',monospace;color:#888;font-size:12px">${t.pct}%</td>
    </tr>`
  }).join('') + `<tr style="border-top:1px solid #2a2a2a">
    <td style="color:#888;font-size:12px;padding-top:8px">Total</td>
    <td style="text-align:right;font-family:'JetBrains Mono',monospace;color:#f59e0b;font-weight:700;padding-top:8px">${fmt(data.total)}</td>
    <td></td>
  </tr>`
}

// Auto-login if token exists
if (TOKEN) {
  apiFetch('/api/stats/live').then(() => showDashboard()).catch(() => {
    localStorage.removeItem('aic_dash_token')
  })
}
</script>
</body>
</html>
